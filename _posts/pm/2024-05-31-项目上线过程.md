---
layout: post
title: cpp项目上线过程
categories: [pm]
tags: [tdd, googletest, valgrind, asan]
date: 2024-05-31 10:00 +0800
---

# 前言

本文记录下项目上线全过程，目的是提出一个规范，确保所实现的功能符合预期，并且能够稳定运行。

# 环境规范

首先，我们定义出三个代码运行环境，并对各环境进行规范要求：
1. 开发环境：开发人员用于编写和调试代码的环境。通常是开发人员本地的开发机。要求：
    * 配置灵活：为了方便开发和调试，开发环境通常会打开所有的错误报告。
    * 独立性：开发环境与测试环境分开，使用独立的客户机、服务器和配置管理工具。
    * 版本最新：开发环境中的代码是最前沿的版本，由开发人员直接使用和维护。
    * 关联分支：某个功能的具体分支（git），或使用开发分支dev（svn）。
        * 代码提交方式：开发人员直接提交到该分支，可用于暂存代码、分享交流代码，无需审核。
2. 测试环境：是测试人员利用一些工具和数据模拟出的接近真实用户使用环境的环境。要求：
    * 接近真实环境：测试环境通常是克隆生产环境的配置，以确保测试结果的真实性和有效性
    * 独立性：测试环境与开发环境分隔开，使用独立的客户机、服务器和配置管理工具
    * 功能测试：测试环境用于功能模块测试、集成测试和系统测试，测试人员在这个环境中进行测试和改bug
    * 关联分支：test分支。
        * 代码提交方式：开发人员发起合并请求，测试人员审核通过后，代码合并到test分支。
        * 触发流程：代码合并后，自动触发CI/CD流程，包括：跑通测试用例、跑通sonarqube测试、自动构建并部署到测试环境。由测试人员跟进测试结果。
3. 生产环境：是用户实际使用的环境。要求：
    * 高稳定性。
    * 灰度发布。
    * 快速回滚。
    * 关联分支：release分支用于存放预发版功能，master分支用于管理正式的提交。
        * 代码提交方式：
            * 测试人员测试通过后，选取当前测试的提交记录(cherry-pick)，发起合并请求，请求将代码合并进release分支。
            * 项目负责人、主策划、技术负责人审核通过后，代码合并到release分支。
            * 到了发版周期，项目负责人、主策划、技术负责人选取release分支功能，合并进master分支。
        * 触发流程：
            * 代码合并进master分支后，自动触发CI流程，包括：跑通测试用例、跑通sonarqube测试、自动构建并灰度部署到生产环境。由运维人员跟进测试结果。
            * 如生产环境灰度过程中有任何问题，运维人员可随时回滚到上一个版本。

# 开发规范

开发环境开发过程中，需要做好：
* 需求分析，整理文档。
* 设计方案，讨论并记录文档。
* 开发实现，遵守编码规范。
* 编写单元测试用例，测试单个函数或模块的功能。注意只需要对核心功能接口编写测试用例即可，同时注意覆盖边界条件测试。
* 提审：开发人员提交代码，并填写需求文档、设计文档、**测试用例文档**。

# 测试规范

测试环境测试过程中，需要做好：
1. 验证单元测试覆盖率符合要求，CI、CD流程中跑通所有测试用例。并正常部署到测试环境。
2. 集成测试：按需编写测试用例，测试多个模块之间的交互。注意需要引入本功能相关联的其他模块，测试其交互过程是否正常。
3. 系统测试：按需编写测试用例，测试整个系统对外提供的接口、功能是否正常。如果本功能涉及新的对外接口，需要编写测试用例。
4. 压力测试：按需编写测试用例，测试系统在高并发、大数据量下的性能表现，很多问题只有在高压力环境下才会暴漏。注意需要使用压力测试工具，如ab、wrk等，编写测试用例，模拟高并发、大数据量场景。

测试环境下相关的测试用例需自动化到CI/CD流程中。测试环境需稳定运行一段时间后，无明显问题，再推进合并到生产环境。